<Page
    x:Class="FluentDL.Views.Search"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:animatedVisuals="using:Microsoft.UI.Xaml.Controls.AnimatedVisuals"
    xmlns:behaviors="using:FluentDL.Behaviors"
    xmlns:controls="clr-namespace:Microsoft.UI.Xaml.Controls;assembly=Microsoft.WinUI"
    xmlns:controls1="using:CommunityToolkit.WinUI.UI.Controls"
    xmlns:controls2="using:Microsoft.UI.Xaml.Controls"
    xmlns:controls3="using:CommunityToolkit.WinUI.Controls"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:helpers="using:FluentDL.Helpers"
    xmlns:marqueeTextRns="using:CommunityToolkit.Labs.WinUI.MarqueeTextRns"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:models="using:FluentDL.Models"
    xmlns:services="using:FluentDL.Services"
    xmlns:views="using:FluentDL.Views"
    x:Name="RootPage"
    NavigationCacheMode="Required"
    mc:Ignorable="d">
    <Page.Resources>
        <helpers:DateToYearConverter x:Key="DateToYearConverter" />
        <helpers:DurationConverter x:Key="DurationConverter" />
        <helpers:VisibilityConverter x:Key="VisibilityConverter" />
        <helpers:CollapsedConverter x:Key="CollapsedConverter" />
        <helpers:SourceToColorConverter x:Key="SourceToColorConverter" />
        <helpers:AlbumCountConverter x:Key="AlbumCountConverter" />
    </Page.Resources>

    <Grid>
        <!--  Advanced search dialog  -->
        <ContentDialog
            x:Name="SearchDialog"
            Title="Advanced Search"
            CloseButtonText="Cancel"
            IsPrimaryButtonEnabled="True"
            IsSecondaryButtonEnabled="True"
            PrimaryButtonClick="SearchDialogClick"
            PrimaryButtonStyle="{ThemeResource AccentButtonStyle}"
            PrimaryButtonText="Search">
            <StackPanel>
                <InfoBar
                    Margin="0,0,0,12"
                    IsClosable="False"
                    IsOpen="True"
                    Message="Strictly search for tracks that match the following criteria. Fields that are left empty will be ignored."
                    Severity="Informational" />

                <TextBox
                    x:Name="artistNameInput"
                    Margin="0,0,0,8"
                    HorizontalAlignment="Stretch"
                    Header="Artist"
                    PlaceholderText="Enter name"
                    ToolTipService.ToolTip="Artist name">
                    <TextBox.HeaderTemplate>
                        <DataTemplate>
                            <TextBlock
                                Foreground="{ThemeResource TextFillColorSecondary}"
                                Style="{ThemeResource CaptionTextBlockStyle}"
                                Text="{Binding}" />
                        </DataTemplate>
                    </TextBox.HeaderTemplate>
                </TextBox>
                <TextBox
                    x:Name="trackNameInput"
                    Margin="0,0,0,8"
                    HorizontalAlignment="Stretch"
                    Header="Track"
                    PlaceholderText="Enter name"
                    ToolTipService.ToolTip="Track name">
                    <TextBox.HeaderTemplate>
                        <DataTemplate>
                            <TextBlock
                                Foreground="{ThemeResource TextFillColorSecondary}"
                                Style="{ThemeResource CaptionTextBlockStyle}"
                                Text="{Binding}" />
                        </DataTemplate>
                    </TextBox.HeaderTemplate>
                </TextBox>
                <TextBox
                    x:Name="albumNameInput"
                    Margin="0,0,0,8"
                    HorizontalAlignment="Stretch"
                    Header="Album"
                    PlaceholderText="Enter name"
                    ToolTipService.ToolTip="Album name">
                    <TextBox.HeaderTemplate>
                        <DataTemplate>
                            <TextBlock
                                Foreground="{ThemeResource TextFillColorSecondary}"
                                Style="{ThemeResource CaptionTextBlockStyle}"
                                Text="{Binding}" />
                        </DataTemplate>
                    </TextBox.HeaderTemplate>
                </TextBox>
            </StackPanel>
        </ContentDialog>

        <!--  Search page  -->
        <Grid>
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="Auto" />
            </Grid.ColumnDefinitions>

            <Grid.RowDefinitions>
                <RowDefinition Height="Auto" />
                <RowDefinition Height="Auto" />
                <RowDefinition Height="Auto" />
                <RowDefinition Height="*" />
            </Grid.RowDefinitions>

            <!--  Search bar and buttons  -->
            <Grid
                x:Name="FirstRowGrid"
                Grid.Row="0"
                Grid.Column="0"
                Margin="0,2,0,8"
                ColumnSpacing="8">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>

                <AutoSuggestBox
                    x:Name="SearchBox"
                    Grid.Column="0"
                    Padding="0"
                    HorizontalAlignment="Stretch"
                    PlaceholderText="Find a track or paste a link"
                    QueryIcon="Find"
                    QuerySubmitted="SearchBox_OnQuerySubmitted"
                    ToolTipService.ToolTip="Search" />

                <Button
                    x:Name="ShowDialogButton"
                    Grid.Column="1"
                    Click="ShowDialog_OnClick_Click"
                    ToolTipService.ToolTip="Open advanced search">
                    <StackPanel Orientation="Horizontal">
                        <FontIcon
                            x:Name="ShowDialogIcon"
                            Margin="0,0,8,0"
                            FontSize="16"
                            Glyph="&#xE71C;" />
                        <TextBlock Text="Advanced" />
                    </StackPanel>
                </Button>

                <DropDownButton
                    x:Name="SourceButton"
                    Grid.Column="2"
                    ToolTipService.ToolTip="Configure search sources">
                    <StackPanel Orientation="Horizontal">
                        <Ellipse
                            x:Name="SourceButtonEllipse"
                            Width="10"
                            Height="10"
                            Margin="0,0,10,0"
                            VerticalAlignment="Center"
                            Fill="White"
                            StrokeThickness="0" />
                        <TextBlock Text="Source" />
                    </StackPanel>
                    <DropDownButton.Flyout>
                        <Flyout Closed="FlyoutBase_OnClosed" Placement="Bottom">
                            <StackPanel Spacing="12">
                                <NumberBox
                                    Width="160"
                                    Header="Results limit"
                                    LargeChange="10"
                                    Maximum="100"
                                    Minimum="1"
                                    SmallChange="5"
                                    SpinButtonPlacementMode="Inline"
                                    ToolTipService.ToolTip="Limit the number of search results"
                                    Value="{x:Bind Path=ViewModel.ResultsLimit, Mode=TwoWay}">
                                    <NumberBox.HeaderTemplate>
                                        <DataTemplate>
                                            <Grid>
                                                <TextBlock
                                                    Foreground="{ThemeResource TextFillColorSecondary}"
                                                    Style="{ThemeResource CaptionTextBlockStyle}"
                                                    Text="{Binding}" />
                                                <FontIcon
                                                    HorizontalAlignment="Right"
                                                    FontSize="16"
                                                    Glyph="&#xE946;"
                                                    ToolTipService.ToolTip="Maximum results for Spotify is 50" />
                                            </Grid>
                                        </DataTemplate>
                                    </NumberBox.HeaderTemplate>
                                </NumberBox>
                                <RadioButtons
                                    x:Name="SourceRadioButtons"
                                    Padding="0"
                                    Header="Override source"
                                    SelectedIndex="0">
                                    <RadioButtons.HeaderTemplate>
                                        <DataTemplate>
                                            <TextBlock
                                                Foreground="{ThemeResource TextFillColorSecondary}"
                                                Style="{ThemeResource CaptionTextBlockStyle}"
                                                Text="{Binding}" />
                                        </DataTemplate>
                                    </RadioButtons.HeaderTemplate>
                                    <RadioButton Content="Deezer" ToolTipService.ToolTip="Get search results from Deezer" />
                                    <RadioButton Content="Qobuz" ToolTipService.ToolTip="Get search results from Qobuz" />
                                    <RadioButton Content="Spotify" ToolTipService.ToolTip="Get search results from Spotify" />
                                    <RadioButton Content="YouTube" ToolTipService.ToolTip="Get search results from YouTube" />
                                </RadioButtons>
                                <ToggleSwitch
                                    x:Name="AlbumModeSwitch"
                                    Header="Album Mode"
                                    IsOn="{x:Bind Path=ViewModel.AlbumMode, Mode=TwoWay}"
                                    ToolTipService.ToolTip="Toggle whether search results are albums or singles">
                                    <ToggleSwitch.HeaderTemplate>
                                        <DataTemplate>
                                            <TextBlock
                                                Foreground="{ThemeResource TextFillColorSecondary}"
                                                Style="{ThemeResource CaptionTextBlockStyle}"
                                                Text="{Binding}" />
                                        </DataTemplate>
                                    </ToggleSwitch.HeaderTemplate>
                                </ToggleSwitch>
                            </StackPanel>
                        </Flyout>
                    </DropDownButton.Flyout>
                </DropDownButton>
            </Grid>

            <!--  Second row of buttons  -->
            <controls1:DockPanel Grid.Row="1" Grid.Column="0">
                <Button
                    x:Name="AddToQueueButton"
                    Margin="0,0,0,0"
                    VerticalAlignment="Center"
                    Background="Transparent"
                    BorderBrush="Transparent"
                    Click="AddToQueueButton_OnClick"
                    ToolTipService.ToolTip="Add all results to queue">
                    <StackPanel Orientation="Horizontal">
                        <FontIcon
                            x:Name="ResultsIcon"
                            Margin="0,0,8,0"
                            FontSize="16"
                            Foreground="{ThemeResource AccentTextFillColorPrimaryBrush}"
                            Glyph="&#xE710;" />
                        <TextBlock x:Name="ResultsText" Foreground="{ThemeResource AccentTextFillColorPrimaryBrush}" />
                    </StackPanel>
                </Button>

                <StackPanel HorizontalAlignment="Right" Orientation="Horizontal">
                    <ComboBox
                        x:Name="SortOrderComboBox"
                        Margin="0,0,0,0"
                        Background="Transparent"
                        BorderBrush="Transparent"
                        DropDownOpened="ComboBox_OnDropDownOpened"
                        PlaceholderText="Sort order:  Ascending"
                        SelectionChanged="SortOrder_SelectionChanged"
                        ToolTipService.ToolTip="Sort from least to greatest value or vice versa">
                        <ComboBox.ItemTemplate>
                            <DataTemplate x:DataType="views:SortObject">
                                <StackPanel Orientation="Horizontal">
                                    <TextBlock Style="{ThemeResource BodyTextBlockStyle}" Text="{x:Bind Text}" />
                                    <TextBlock
                                        Foreground="{ThemeResource AccentTextFillColorPrimaryBrush}"
                                        Style="{ThemeResource BodyTextBlockStyle}"
                                        Text="{x:Bind Highlight}" />
                                </StackPanel>
                            </DataTemplate>
                        </ComboBox.ItemTemplate>
                        <ComboBox.Items>
                            <views:SortObject Highlight="  Ascending" Text="Sort order:" />
                            <views:SortObject Highlight="  Descending" Text="Sort order:" />
                        </ComboBox.Items>
                    </ComboBox>
                    <ComboBox
                        x:Name="SortComboBox"
                        Background="Transparent"
                        BorderBrush="Transparent"
                        DropDownOpened="ComboBox_OnDropDownOpened"
                        PlaceholderText="Sort by:  Relevance"
                        SelectionChanged="SortBox_SelectionChanged"
                        ToolTipService.ToolTip="Sort results by field">
                        <ComboBox.ItemTemplate>
                            <DataTemplate x:DataType="views:SortObject">
                                <StackPanel Orientation="Horizontal">
                                    <TextBlock Style="{ThemeResource BodyTextBlockStyle}" Text="{x:Bind Text}" />
                                    <TextBlock
                                        Foreground="{ThemeResource AccentTextFillColorPrimaryBrush}"
                                        Style="{ThemeResource BodyTextBlockStyle}"
                                        Text="{x:Bind Highlight}" />
                                </StackPanel>
                            </DataTemplate>
                        </ComboBox.ItemTemplate>
                        <ComboBox.Items>
                            <views:SortObject Highlight="  Relevance" Text="Sort by:" />
                            <views:SortObject Highlight="  A - Z" Text="Sort by:" />
                            <views:SortObject Highlight="  Artist" Text="Sort by:" />
                            <views:SortObject Highlight="  Release date" Text="Sort by:" />
                            <views:SortObject Highlight="  Popularity" Text="Sort by:" />
                        </ComboBox.Items>
                    </ComboBox>
                    <Button
                        x:Name="StopSearchButton"
                        VerticalAlignment="Center"
                        Background="Transparent"
                        BorderBrush="Transparent"
                        Click="StopSearchButton_OnClick"
                        ToolTipService.ToolTip="Stop loading results">
                        <StackPanel Orientation="Horizontal">
                            <FontIcon
                                x:Name="StopSearchIcon"
                                Margin="0,0,8,0"
                                FontSize="16"
                                Foreground="{ThemeResource AccentTextFillColorPrimaryBrush}"
                                Glyph="&#xE71A;" />
                            <TextBlock Foreground="{ThemeResource AccentTextFillColorPrimaryBrush}" Text="Stop" />
                        </StackPanel>
                    </Button>
                </StackPanel>
            </controls1:DockPanel>

            <!--  Row 3: Progress bar  -->
            <ProgressBar
                x:Name="SearchProgress"
                Grid.Row="2"
                Grid.Column="0"
                Margin="0,8,0,12"
                IsIndeterminate="False"
                Value="0" />

            <!--  Row 4: No results text and listview  -->
            <TextBlock
                x:Name="NoSearchResults"
                Grid.Row="3"
                Grid.Column="0"
                Margin="0,0,0,10"
                HorizontalAlignment="Center"
                VerticalAlignment="Center"
                Style="{ThemeResource BodyTextBlockStyle}"
                Text="No results found." />

            <ListView
                x:Name="CustomListView"
                Grid.Row="3"
                Grid.Column="0"
                Margin="0,0,0,12"
                Padding="0,0,12,0"
                BorderBrush="{ThemeResource ControlStrongStrokeColorDefaultBrush}"
                BorderThickness="0"
                CornerRadius="8"
                SelectionChanged="CustomListView_OnSelectionChanged"
                ShowsScrollingPlaceholders="True">
                <ListView.ItemTemplate>
                    <DataTemplate x:DataType="models:SongSearchObject">
                        <Grid
                            Height="76"
                            Margin="0,12,0,12"
                            AutomationProperties.Name="{x:Bind Title}">
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto" />
                                <RowDefinition Height="Auto" />
                                <RowDefinition Height="*" />
                            </Grid.RowDefinitions>

                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="76" />
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="Auto" />
                            </Grid.ColumnDefinitions>

                            <Border
                                Grid.Row="0"
                                Grid.RowSpan="3"
                                Grid.Column="0"
                                Height="76"
                                CornerRadius="4">
                                <Border.Background>
                                    <ImageBrush ImageSource="{x:Bind ImageLocation}" Stretch="UniformToFill" />
                                </Border.Background>
                            </Border>

                            <marqueeTextRns:MarqueeText
                                Grid.Row="0"
                                Grid.Column="1"
                                Margin="12,0,0,0"
                                VerticalAlignment="Center"
                                Behavior="Looping"
                                Direction="Left"
                                FontFamily="Segoe UI Variable Display"
                                FontWeight="Semibold"
                                RepeatBehavior="Forever"
                                Text="{x:Bind Title}" />


                            <marqueeTextRns:MarqueeText
                                Grid.Row="1"
                                Grid.Column="1"
                                Margin="12,0,0,0"
                                VerticalAlignment="Center"
                                Behavior="Looping"
                                Direction="Left"
                                FontFamily="Segoe UI Variable Display"
                                Foreground="{ThemeResource TextFillColorSecondary}"
                                RepeatBehavior="Forever"
                                Text="{x:Bind Artists}" />

                            <StackPanel
                                Grid.Row="2"
                                Grid.Column="1"
                                Margin="12,0,0,0"
                                VerticalAlignment="Bottom"
                                Orientation="Horizontal">
                                <TextBlock
                                    Margin="0,0,0,0"
                                    HorizontalAlignment="Left"
                                    FontFamily="Segoe UI Variable Display"
                                    Foreground="{ThemeResource TextFillColorSecondary}"
                                    Style="{ThemeResource BodyTextBlockStyle}"
                                    Text="{x:Bind ReleaseDate, Converter={StaticResource DateToYearConverter}}" />
                                <TextBlock
                                    HorizontalAlignment="Left"
                                    FontFamily="Segoe UI Variable Display"
                                    Foreground="{ThemeResource TextFillColorSecondary}"
                                    Style="{ThemeResource BodyTextBlockStyle}"
                                    Text="&#160;&#x2022;&#160;&#xfeff;" />
                                <TextBlock
                                    HorizontalAlignment="Left"
                                    FontFamily="Segoe UI Variable Display"
                                    Foreground="{ThemeResource TextFillColorSecondary}"
                                    Style="{ThemeResource BodyTextBlockStyle}"
                                    Text="{x:Bind Duration, Converter={StaticResource DurationConverter}}" />
                                <TextBlock
                                    HorizontalAlignment="Left"
                                    FontFamily="Segoe UI Variable Display"
                                    Foreground="{ThemeResource TextFillColorSecondary}"
                                    Style="{ThemeResource BodyTextBlockStyle}"
                                    Text="{x:Bind Converter={StaticResource AlbumCountConverter}}" />
                            </StackPanel>

                            <StackPanel
                                Grid.Row="0"
                                Grid.Column="2"
                                Margin="12,0,0,0"
                                HorizontalAlignment="Right"
                                Orientation="Horizontal"
                                Spacing="12">
                                <Border
                                    Margin="0,-2,0,0"
                                    Padding="4,0"
                                    HorizontalAlignment="Right"
                                    VerticalAlignment="Center"
                                    Background="DarkGray"
                                    CornerRadius="2"
                                    Visibility="{x:Bind Explicit, Converter={StaticResource VisibilityConverter}}">
                                    <TextBlock
                                        x:Name="ExplicitBadge"
                                        Foreground="Black"
                                        Style="{ThemeResource CaptionTextBlockStyle}"
                                        Text="E" />
                                </Border>
                                <Border
                                    Padding="6,2"
                                    HorizontalAlignment="Right"
                                    VerticalAlignment="Top"
                                    Background="{ThemeResource LayerOnMicaBaseAltFillColorSecondaryBrush}"
                                    CornerRadius="2">
                                    <StackPanel Orientation="Horizontal">
                                        <Ellipse
                                            Width="10"
                                            Height="10"
                                            Margin="0,0,6,0"
                                            VerticalAlignment="Center"
                                            Fill="{x:Bind Source, Converter={StaticResource SourceToColorConverter}}"
                                            StrokeThickness="0" />
                                        <TextBlock
                                            x:Name="SourceBadge"
                                            Margin="0,-2,0,0"
                                            VerticalAlignment="Center"
                                            Style="{ThemeResource CaptionTextBlockStyle}"
                                            Text="{x:Bind Source}" />
                                    </StackPanel>
                                </Border>
                            </StackPanel>

                            <!--  shortcut buttons  -->
                            <StackPanel
                                Grid.Row="2"
                                Grid.Column="2"
                                HorizontalAlignment="Right"
                                VerticalAlignment="Bottom"
                                Orientation="Horizontal"
                                Spacing="4">
                                <Button
                                    x:Name="AddQueueButton"
                                    Padding="4,4,3,3"
                                    HorizontalAlignment="Right"
                                    VerticalAlignment="Bottom"
                                    Click="AddQueueButton_OnClick"
                                    Tag="{Binding}"
                                    ToolTipService.ToolTip="Add to queue"
                                    Visibility="{Binding ElementName=RootPage, Path=ViewModel.AddQueueVisibility}">
                                    <FontIcon
                                        x:Name="AddQueueIcon"
                                        FontSize="20"
                                        Glyph="&#xE710;" />
                                </Button>
                                <Button
                                    x:Name="DownloadButton"
                                    Padding="4,4,3,3"
                                    HorizontalAlignment="Right"
                                    VerticalAlignment="Bottom"
                                    Click="DownloadButton_Click"
                                    Tag="{Binding}"
                                    ToolTipService.ToolTip="Download track"
                                    Visibility="{Binding ElementName=RootPage, Path=ViewModel.DownloadVisibility}">
                                    <FontIcon
                                        x:Name="DownloadIcon"
                                        FontSize="20"
                                        Glyph="&#xE896;" />
                                </Button>
                                <Button
                                    x:Name="ShareLinkButton"
                                    Padding="4,4,3,3"
                                    HorizontalAlignment="Right"
                                    VerticalAlignment="Bottom"
                                    Click="ShareLinkButton_OnClick"
                                    Tag="{Binding}"
                                    ToolTipService.ToolTip="Copy track link"
                                    Visibility="{Binding ElementName=RootPage, Path=ViewModel.ShareVisibility}">
                                    <FontIcon
                                        x:Name="ShareLinkIcon"
                                        FontSize="20"
                                        Glyph="&#xE71B;" />
                                </Button>
                                <Button
                                    x:Name="OpenInBrowserButton"
                                    Padding="4,4,3,3"
                                    HorizontalAlignment="Right"
                                    VerticalAlignment="Bottom"
                                    Click="OpenInBrowserButton_OnClick"
                                    Tag="{Binding}"
                                    ToolTipService.ToolTip="Open in browser"
                                    Visibility="{Binding ElementName=RootPage, Path=ViewModel.OpenVisibility}">
                                    <FontIcon
                                        x:Name="OpenLinkIcon"
                                        FontSize="20"
                                        Glyph="&#xE8A7;" />
                                </Button>
                            </StackPanel>
                        </Grid>
                    </DataTemplate>
                </ListView.ItemTemplate>
            </ListView>
            <views:PreviewPane
                x:Name="PreviewPanel"
                Grid.Row="0"
                Grid.RowSpan="4"
                Grid.Column="1"
                Margin="12,0,0,12"
                Padding="12"
                VerticalAlignment="Stretch" />

        </Grid>

        <!--  InfoBar  -->
        <InfoBar
            x:Name="PageInfoBar"
            Margin="12"
            HorizontalAlignment="Center"
            VerticalAlignment="Bottom"
            HorizontalContentAlignment="Stretch"
            x:FieldModifier="public"
            Background="{ThemeResource AcrylicBackgroundFillColorDefaultBrush}"
            Canvas.ZIndex="1"
            CloseButtonClick="PageInfoBar_OnCloseButtonClick"
            IsOpen="False"
            Opacity="0">
            <InfoBar.OpacityTransition>
                <ScalarTransition Duration="0:0:0.25" />
            </InfoBar.OpacityTransition>
            <InfoBar.Content>
                <StackPanel Orientation="Horizontal">
                    <Grid
                        x:Name="InfobarContent"
                        Margin="0,0,0,0"
                        Padding="0,0,0,0"
                        VerticalAlignment="Center">
                        <TextBlock
                            x:Name="InfoBarTextBlock"
                            Margin="0,0,0,0"
                            VerticalAlignment="Center" />
                        <ProgressBar
                            x:Name="InfobarProgress"
                            Margin="0,0,0,-8"
                            HorizontalAlignment="Stretch"
                            VerticalAlignment="Bottom"
                            IsIndeterminate="True"
                            Visibility="Collapsed" />
                    </Grid>
                    <Button
                        x:Name="InfobarButton"
                        Margin="12,0,0,0"
                        Content="test"
                        Visibility="Collapsed" />
                </StackPanel>
            </InfoBar.Content>
        </InfoBar>

    </Grid>
</Page>